<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analiz - Sabancı KDS</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Custom Theme -->
    <link rel="stylesheet" href="/css/analiz.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body class="bg-light">

    <%- include('partials/header', { path: '/' }) %>

        <div class="container py-4">

            <% if (locals.error) { %>
                <div class="alert alert-danger mb-4" role="alert">
                    <strong>Hata:</strong>
                    <%= error %>
                </div>
                <% } %>

                    <!-- Row 1: Key Metrics (KPIs) -->
                    <div class="row g-3 mb-4">
                        <!-- Annual Revenue -->
                        <div class="col-md-6 col-lg-4">
                            <div class="kds-card kds-fade-in-up" style="animation-delay: 100ms;">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="text-secondary fw-bold text-uppercase small"
                                        style="font-size: 0.7rem;">Yıllık Gelir (TL)</span>
                                    <span class="badge bg-light text-secondary border rounded-pill fw-normal"
                                        style="font-size: 10px;">OTOMATİK</span>
                                </div>
                                <!-- Interactive Big Number Input -->
                                <div class="kds-input-wrapper mt-auto">
                                    <input type="text" id="annual_revenue"
                                        value="<%= new Intl.NumberFormat('tr-TR', { maximumFractionDigits: 2 }).format(settings.annual_revenue) %>"
                                        class="kds-input-display"
                                        onfocus="this.value = this.value.replace(/\./g, '').replace(',', '.')"
                                        onblur="formatRevenueInternal(this)" onchange="updateRevenue(this.value)">
                                </div>
                            </div>
                        </div>

                        <!-- Entrepreneur Budget -->
                        <div class="col-md-6 col-lg-4">
                            <div class="kds-card kds-fade-in-up" style="animation-delay: 200ms;">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="text-secondary fw-bold text-uppercase small" id="budget_label"
                                        style="font-size: 0.7rem;">KADIN GİRİŞİMCİ BÜTÇESİ (%70)</span>
                                    <svg class="text-success" style="width: 16px; height: 16px;" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div class="kds-input-wrapper mt-auto">
                                    <div class="kds-input-display text-success border-0 px-0 ms-0"
                                        id="calculated_budget">
                                        <%= new Intl.NumberFormat('tr-TR', { style: 'currency' , currency: 'TRY'
                                            }).format(settings.annual_revenue * settings.budget_ratio) %>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action: Benchmark Selection -->
                        <div class="col-md-12 col-lg-4">
                            <div onclick="const el = document.getElementById('firmSelectModal'); const modal = bootstrap.Modal.getInstance(el) || new bootstrap.Modal(el); modal.show();"
                                class="kds-card kds-action-card kds-fade-in-up text-decoration-none"
                                style="animation-delay: 300ms; padding: 1.5rem;">
                                <div class="kds-action-content">
                                    <div class="pe-3">
                                        <h3 class="h6 mb-1 text-dark fw-bold">Referans Firma Seçiniz</h3>
                                    </div>
                                    <div class="kds-action-icon">
                                        <svg style="width: 24px; height: 24px;" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2: Analytics Grid -->
                    <div class="row g-3 mb-4">
                        <!-- Doughnut Chart: Top 5 Firms -->
                        <div class="col-lg-5 col-xl-4">
                            <div class="kds-card kds-fade-in-up" style="animation-delay: 400ms;">
                                <div class="mb-3 d-flex justify-content-between align-items-center">
                                    <div>
                                        <h3 class="h6 fw-bold text-dark mb-0">Sürdürülebilirlik Liderleri</h3>
                                    </div>
                                </div>
                                <div class="position-relative d-flex justify-content-center align-items-center"
                                    style="height: 220px;">
                                    <canvas id="topFirmsChart"></canvas>
                                    <!-- Center Text Overlay for Doughnut -->
                                    <div class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column align-items-center justify-content-center pe-none"
                                        style="pointer-events: none;">
                                        <span class="h2 fw-bold text-dark mb-0" style="line-height:1;">7</span>
                                        <span class="fw-bold text-secondary text-uppercase"
                                            style="font-size: 0.6rem;">Firma</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Line Chart: Carbon Footprint -->
                        <div class="col-lg-7 col-xl-8">
                            <div class="kds-card kds-fade-in-up" style="animation-delay: 500ms;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h3 class="h6 fw-bold text-dark mb-0">Karbon Ayak İzi Trendi</h3>
                                    </div>
                                    <!-- Inline Control -->
                                    <div class="kds-control-bar">
                                        <div class="kds-control-item border-0 bg-transparent shadow-none p-1">
                                            <span class="kds-label-micro">EŞİK (TON)</span>
                                            <input type="number" id="carbon_threshold"
                                                value="<%= settings.carbon_threshold %>"
                                                class="kds-input-micro text-end fw-bold" oninput="updateCarbonChart()"
                                                onchange="updateSetting('carbon_threshold', this.value)"
                                                style="width: 50px;">
                                        </div>
                                    </div>
                                </div>
                                <div class="position-relative" style="height: 220px;">
                                    <canvas id="carbonChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Row 3: Advanced Analysis (Entrepreneurs) -->
                    <div class="row mb-5">
                        <div class="col-12">
                            <div class="kds-card kds-fade-in-up" style="animation-delay: 600ms;">
                                <div
                                    class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
                                    <div class="mb-3 mb-md-0">
                                        <h3 class="h5 fw-bold text-dark mb-0">Girişimci Uygunluk Analizi</h3>
                                        <span class="text-secondary small">Dinamik Kriter Puanlama</span>
                                    </div>

                                    <!-- Modern Control Bar -->
                                    <div class="kds-control-bar">
                                        <div class="kds-control-item">
                                            <label class="kds-label-micro">Referans Yıl</label>
                                            <input type="number" id="ref_year" value="<%= settings.ref_year %>"
                                                class="kds-input-micro" oninput="updateEntChart()"
                                                onchange="updateSetting('reference_founding_year', this.value)">
                                        </div>
                                        <div class="kds-control-item">
                                            <label class="kds-label-micro">Referans Kadın Çalışan</label>
                                            <input type="number" id="ref_female" value="<%= settings.ref_female %>"
                                                class="kds-input-micro" oninput="updateEntChart()"
                                                onchange="updateSetting('reference_female_employees', this.value)">
                                        </div>
                                        <div class="kds-control-item">
                                            <label class="kds-label-micro">Referans Engelli Çalışan</label>
                                            <input type="number" id="ref_disabled" value="<%= settings.ref_disabled %>"
                                                class="kds-input-micro" oninput="updateEntChart()"
                                                onchange="updateSetting('reference_disabled_employees', this.value)">
                                        </div>
                                    </div>
                                </div>

                                <div class="position-relative" style="height: 320px;">
                                    <canvas id="entChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Firm Selection Modal (Bootstrap Modal) -->
                    <div class="modal fade" id="firmSelectModal" tabindex="-1" aria-labelledby="firmSelectModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
                                <div class="modal-header border-0 pb-0">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="bg-indigo-light rounded-circle d-flex align-items-center justify-content-center"
                                            style="width: 40px; height: 40px; background-color: #e0e7ff;">
                                            <svg class="text-primary" style="width: 20px; height: 20px;" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                            </svg>
                                        </div>
                                        <h5 class="modal-title fw-bold text-dark" id="firmSelectModalLabel">Lider Firma
                                            Seçimi</h5>
                                    </div>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body pt-2">
                                    <p class="text-secondary small mb-4">Bir firma seçtiğinizde, sistemin yıllık geliri
                                        bu firmanın cirosuna eşitlenecektir.</p>

                                    <div class="list-group list-group-flush"
                                        style="max-height: 300px; overflow-y: auto;">
                                        <% topFirms.forEach((f, index)=> { %>
                                            <a href="#" onclick="selectBenchmarkFirm(<%= index %>); return false;"
                                                class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3 mb-2 border rounded hover-bg-light"
                                                style="background-color: #f8fafc;">
                                                <div>
                                                    <div class="fw-bold text-dark">
                                                        <%= f.name %>
                                                    </div>
                                                    <small class="text-secondary">Ciro: <%= new
                                                            Intl.NumberFormat('tr-TR', { style: 'currency' ,
                                                            currency: 'TRY' }).format(f.yillik_ciro) %></small>
                                                </div>
                                                <span class="badge bg-primary rounded-pill">SEÇ</span>
                                            </a>
                                            <% }) %>
                                    </div>
                                </div>
                                <div class="modal-footer border-0">
                                    <button type="button" class="btn btn-light w-100 py-2 border"
                                        data-bs-dismiss="modal">İptal</button>
                                </div>
                            </div>
                        </div>
                    </div>

        </div> <!-- End Container -->

        <!-- HIDDEN DATA CONTAINERS (Safe Injection) -->
        <script type="application/json" id="data-top-firms"><%- JSON.stringify(topFirms || []) %></script>
        <script type="application/json" id="data-carbon-firms"><%- JSON.stringify(carbonFirms || []) %></script>
        <script type="application/json" id="data-top-ents"><%- JSON.stringify(topEnts || []) %></script>
        <script type="application/json" id="data-settings"><%- JSON.stringify(settings || {}) %></script>

        <!-- Scripts -->
        <script>
            // --- DATA INJECTION (SAFE PARSING) ---
            // Data is injected into hidden script tags to avoid Syntax Errors
            const TOP_FIRMS = JSON.parse(document.getElementById('data-top-firms').textContent || '[]');
            const CARBON_FIRMS = JSON.parse(document.getElementById('data-carbon-firms').textContent || '[]');
            // Settings Injection
            const settingsData = JSON.parse(document.getElementById('data-settings').textContent || '{}');
            // User requested 70% budget by default
            let BUDGET_RATIO = 0.70;

            // Shuffle Function for Fisher-Yates (Randomize Order)
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // Shuffle the entrepreneurs initially for "Disproportionate" look
            const ORIGINAL_ENTS = JSON.parse(document.getElementById('data-top-ents').textContent || '[]');
            let CURRENT_ENTS = shuffleArray([...ORIGINAL_ENTS]); // Shuffle immediately

            function selectBenchmarkFirm(index) {
                const firm = TOP_FIRMS[index];
                if (!firm) return;

                // Update Annual Revenue Input with ML Return
                const revenueInput = document.getElementById('annual_revenue');
                // Set formatted value
                revenueInput.value = new Intl.NumberFormat('tr-TR', { maximumFractionDigits: 2 }).format(firm.ml_return || 0);

                // Update Ratio to 70% for Women Entrepreneurs
                BUDGET_RATIO = 0.70;
                document.getElementById('budget_label').innerText = 'KADIN GİRİŞİMCİ BÜTÇESİ (%70)';

                // Trigger Calculations & Save
                updateCalculations();
                // We typically save the base revenue, not the ratio change permanently (unless requested)
                // For now, only updating revenue setting
                updateSetting('annual_revenue', firm.ml_return);

                // Close Modal
                const modalEl = document.getElementById('firmSelectModal');
                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                if (modalInstance) {
                    modalInstance.hide();
                } else {
                    // Fallback if instance lost
                    const newModal = new bootstrap.Modal(modalEl);
                    newModal.hide();
                }

                // Highlight
                revenueInput.classList.add('bg-green-100');
                setTimeout(() => revenueInput.classList.remove('bg-green-100'), 1000);
            }
            // --- CHART INSTANCES ---
            let pieChart, lineChart, barChart;

            // --- INITIALIZE CHARTS ---
            window.onload = function () {
                initPieChart();
                initLineChart();
                initBarChart();
            };

            // 1. PIE CHART (Now DOUGHNUT for Modern Look)
            function initPieChart() {
                const ctx = document.getElementById('topFirmsChart').getContext('2d');
                pieChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: TOP_FIRMS.map(f => f.name),
                        datasets: [{
                            data: TOP_FIRMS.map(f => f.sustainability_score),
                            backgroundColor: ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5'], // Emerald Gradient
                            hoverOffset: 6,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '75%', // Make it a thin modern ring
                        plugins: {
                            tooltip: {
                                backgroundColor: '#1e293b',
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function (context) {
                                        const firm = TOP_FIRMS[context.dataIndex];
                                        return ` ${firm.name}: ${firm.sustainability_score} Puan`;
                                    }
                                }
                            },
                            legend: { display: false } // We have a list in modal, clean look here
                        }
                    }
                });
            }

            // 2. LINE CHART (Clean Grid)
            function initLineChart() {
                const ctx = document.getElementById('carbonChart').getContext('2d');
                const threshold = parseFloat(document.getElementById('carbon_threshold').value) || 500;

                lineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: CARBON_FIRMS.map(f => f.name),
                        datasets: [
                            {
                                label: 'Karbon Ayak İzi',
                                data: CARBON_FIRMS.map(f => f.carbon_footprint),
                                borderColor: '#2563eb', // Royal Blue
                                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 3,
                                pointBackgroundColor: '#ffffff',
                                pointBorderColor: '#2563eb',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                order: 2
                            },
                            {
                                label: 'Referans Değer',
                                data: Array(CARBON_FIRMS.length).fill(threshold),
                                borderColor: '#ef4444', // Red
                                borderDash: [6, 6],
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false,
                                order: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index',
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#1e293b',
                                padding: 12,
                                cornerRadius: 8
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { color: '#94a3b8' }
                            },
                            y: {
                                grid: { color: '#f1f5f9', borderDash: [5, 5] },
                                ticks: { color: '#94a3b8' },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            function updateCarbonChart() {
                const newThresh = parseFloat(document.getElementById('carbon_threshold').value) || 0;
                lineChart.data.datasets[1].data = Array(CARBON_FIRMS.length).fill(newThresh);
                lineChart.update();
            }

            // 3. BAR CHART (Clean & Professional)
            function initBarChart() {
                const ctx = document.getElementById('entChart').getContext('2d');
                recalculateEntScores();

                barChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: CURRENT_ENTS.map(e => e.business_name),
                        datasets: [
                            // Main Score Bar
                            {
                                label: 'Uygunluk Skoru',
                                data: CURRENT_ENTS.map(e => e.calculated_score),
                                backgroundColor: CURRENT_ENTS.map(e => {
                                    if (e.calculated_score > 80) return '#10b981'; // Green
                                    if (e.calculated_score > 50) return '#f59e0b'; // Amber
                                    return '#ef4444'; // Red
                                }),
                                borderRadius: 6,
                                barThickness: 40,
                                order: 2
                            },
                            // Dynamic Reference Lines
                            {
                                type: 'line',
                                label: 'Ref. Yıl',
                                data: Array(CURRENT_ENTS.length).fill(mapRefToY('year', document.getElementById('ref_year').value)),
                                borderColor: '#3b82f6',
                                borderDash: [5, 5],
                                pointRadius: 0,
                                borderWidth: 2,
                                order: 1
                            },
                            {
                                type: 'line',
                                label: 'Ref. Kadın',
                                data: Array(CURRENT_ENTS.length).fill(mapRefToY('female', document.getElementById('ref_female').value)),
                                borderColor: '#ec4899',
                                borderDash: [5, 5],
                                pointRadius: 0,
                                borderWidth: 2,
                                order: 1
                            },
                            {
                                type: 'line',
                                label: 'Ref. Engelli',
                                data: Array(CURRENT_ENTS.length).fill(mapRefToY('disabled', document.getElementById('ref_disabled').value)),
                                borderColor: '#8b5cf6',
                                borderDash: [5, 5],
                                pointRadius: 0,
                                borderWidth: 2,
                                order: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 800,
                            easing: 'easeOutQuart'
                        },
                        layout: {
                            padding: { bottom: 10 }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#1e293b',
                                padding: 12,
                                cornerRadius: 8
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: {
                                    color: '#334155',
                                    font: { weight: '600', size: 11 },
                                    autoSkip: false,
                                    maxRotation: 45,
                                    minRotation: 0
                                }
                            },
                            y: {
                                display: false,
                                grid: { color: '#f1f5f9' },
                                beginAtZero: true,
                                max: 120
                            }
                        }
                    }
                });
            }

            function updateEntChart() {
                recalculateEntScores();

                // Update Bar Data
                barChart.data.labels = CURRENT_ENTS.map(e => e.business_name);
                barChart.data.datasets[0].data = CURRENT_ENTS.map(e => e.calculated_score);
                barChart.data.datasets[0].backgroundColor = CURRENT_ENTS.map(e => {
                    if (e.calculated_score > 80) return '#22c55e';
                    if (e.calculated_score > 50) return '#f59e0b';
                    return '#ef4444';
                });

                // Update Reference Lines (Move them based on inputs)
                const refYear = document.getElementById('ref_year').value;
                const refFemale = document.getElementById('ref_female').value;
                const refDisabled = document.getElementById('ref_disabled').value;

                barChart.data.datasets[1].data = Array(CURRENT_ENTS.length).fill(mapRefToY('year', refYear));
                barChart.data.datasets[2].data = Array(CURRENT_ENTS.length).fill(mapRefToY('female', refFemale));
                barChart.data.datasets[3].data = Array(CURRENT_ENTS.length).fill(mapRefToY('disabled', refDisabled));

                barChart.update();
            }

            // Helper to map abstract inputs to Y-axis chart position (0-100)
            function mapRefToY(type, val) {
                val = parseFloat(val) || 0;
                // Arbitrary mapping for visual feedback requested by user
                if (type === 'year') return Math.max(0, Math.min(100, (val - 2000) * 4)); // 2000->0, 2025->100
                if (type === 'female') return Math.max(0, Math.min(100, val)); // 0-100 direct
                if (type === 'disabled') return Math.max(0, Math.min(100, val * 10)); // 0->0, 10->100
                return 0;
            }

            function recalculateEntScores() {
                // Get current reference values
                const refYear = parseFloat(document.getElementById('ref_year').value) || 2020;
                const refFemale = parseFloat(document.getElementById('ref_female').value) || 0;
                const refDisabled = parseFloat(document.getElementById('ref_disabled').value) || 0;

                // Weighted Scoring Algorithm (Ensure Variance)
                CURRENT_ENTS = ORIGINAL_ENTS.map(e => {
                    let score = 50; // Base Score

                    // 1. Year Impact (Sensitive): +/- 5 points per year diff
                    score += (e.founding_year - refYear) * 5;

                    // 2. Female Impact: +1 point per person (Max 30)
                    let femaleScore = (e.female_employees_count - refFemale) * 1;
                    score += femaleScore; // Can be negative

                    // 3. Disabled Impact: +10 points per person
                    let disabledScore = (e.disabled_employees_count - refDisabled) * 10;
                    score += disabledScore;

                    // Random noise to prevent identical scores if data is static
                    // score += Math.random() * 5; 

                    return {
                        ...e,
                        calculated_score: Math.max(10, Math.min(100, score)) // Clamp 10-100
                    };
                });

                // Re-sort removed to keep the "disproportionate" shuffled look requested by user
                // CURRENT_ENTS.sort((a, b) => b.calculated_score - a.calculated_score);
            }


            // --- UTILITIES ---
            function updateCalculations() {
                // Parse formatted value
                const rawVal = document.getElementById('annual_revenue').value.replace(/\./g, '').replace(',', '.');
                const rev = parseFloat(rawVal) || 0;

                const budget = rev * BUDGET_RATIO;
                document.getElementById('calculated_budget').innerText = new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(budget);
            }

            function formatRevenueInternal(input) {
                // Convert back to number then format
                let val = input.value.replace(/\./g, '').replace(',', '.');
                let num = parseFloat(val);
                if (isNaN(num)) num = 0;

                // Format display
                input.value = new Intl.NumberFormat('tr-TR', { maximumFractionDigits: 2 }).format(num);

                updateCalculations();
                // Trigger save
                updateSetting('annual_revenue', num);
            }

            function updateRevenue(val) {
                // handled in formatRevenueInternal but kept for safety if needed
            }

            async function updateSetting(key, value) {
                // Debounce could be good here, but direct call is simple enough
                try {
                    await fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ key, value })
                    });
                } catch (e) { console.error("Setting save failed", e); }
            }
        </script>

</body>

</html>